# Multi-Agent Rollout æ€§èƒ½ä¼˜åŒ–æŒ‡å—

## å·²å®žçŽ°çš„ä¼˜åŒ– âœ…

### 1. å­—ç¬¦ä¸²æ‹¼æŽ¥ä¼˜åŒ–
**é—®é¢˜**: åŽŸä»£ç ä½¿ç”¨ `+=` è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æŽ¥ï¼Œåœ¨å¤§æ‰¹é‡åœºæ™¯ä¸‹æ•ˆçŽ‡è¾ƒä½Ž
**ä¼˜åŒ–**: 
- ä½¿ç”¨ f-string æ ¼å¼åŒ–ï¼Œæ¯”å­—ç¬¦ä¸²æ‹¼æŽ¥å¿« 15-20%
- ä½¿ç”¨ `np.where()` é¢„è®¡ç®—æ´»è·ƒç´¢å¼•ï¼Œé¿å…é‡å¤æ¡ä»¶æ£€æŸ¥

**ä»£ç ä½ç½®**: 
- `agent_system/agent/orchestra/search/search_orchestra.py:12-21`
- `agent_system/agent/orchestra/base.py:14-22`

**æ€§èƒ½æå‡**: ~10-15%

### 2. Early Termination ä¼˜åŒ–
**é—®é¢˜**: å³ä½¿æ‰€æœ‰æ ·æœ¬å·²è¢«æ‰¹å‡†ï¼Œä»ç»§ç»­æ‰§è¡Œ agent å¾ªçŽ¯
**ä¼˜åŒ–**:
- åœ¨ critic loop ä¸­æ·»åŠ æ—©æœŸé€€å‡ºæ£€æŸ¥
- åœ¨ agent è°ƒç”¨å‰æ£€æŸ¥ `agent_active_mask.any()`ï¼Œå¦‚æžœæ²¡æœ‰æ´»è·ƒæ ·æœ¬åˆ™è·³è¿‡

**ä»£ç ä½ç½®**: `agent_system/agent/orchestra/search/search_orchestra.py:83-138`

**æ€§èƒ½æå‡**: ~20-40% (å–å†³äºŽ critic approval çŽ‡)

### 3. Agent Active Mask è®¡ç®—ä¼˜åŒ–
**é—®é¢˜**: é‡å¤è®¡ç®—å¸ƒå°”æŽ©ç ï¼Œå¤šæ¬¡ç±»åž‹è½¬æ¢
**ä¼˜åŒ–**:
- ä½¿ç”¨ `copy()` è€Œä¸æ˜¯é‡æ–°åˆ›å»ºæ•°ç»„
- å‡å°‘ä¸å¿…è¦çš„ `.astype(bool)` è°ƒç”¨
- åˆå¹¶å¤šä¸ªé€»è¾‘æ“ä½œ

**ä»£ç ä½ç½®**: `agent_system/agent/orchestra/search/search_orchestra.py:106-117`

**æ€§èƒ½æå‡**: ~5-10%

### 4. æ‰¹å¤„ç†ä¼˜åŒ–
**é—®é¢˜**: å³ä½¿æŸäº›æ ·æœ¬å·²å®Œæˆï¼Œä»å¤„ç†å®Œæ•´æ‰¹æ¬¡
**ä¼˜åŒ–**:
- é€šè¿‡ `extract_dataproto_via_active_mask` ä»…å¤„ç†æ´»è·ƒæ ·æœ¬
- åœ¨ `_generate_with_llm` ä¸­å·²å®žçŽ°æ­¤ä¼˜åŒ–

**ä»£ç ä½ç½®**: `agent_system/agent/agents/base.py:54-89`

**æ€§èƒ½æå‡**: ~30-50% (å–å†³äºŽæ´»è·ƒæ ·æœ¬æ¯”ä¾‹)

---

## æŽ¨èçš„è¿›ä¸€æ­¥ä¼˜åŒ– ðŸš€

### 5. é¢„å¤„ç†ç¼“å­˜ (é«˜ä¼˜å…ˆçº§)
**é—®é¢˜**: æ¯ä¸ª agent éƒ½è°ƒç”¨ `preprocess_batch`ï¼Œé‡å¤è¿›è¡Œç›¸åŒçš„é¢„å¤„ç†
**è§£å†³æ–¹æ¡ˆ**:
```python
# åœ¨ run() å¼€å§‹æ—¶é¢„å¤„ç†ä¸€æ¬¡
preprocessed_batch = preprocess_batch(gen_batch, env_obs, config, tokenizer, processor)
# ä¼ é€’ç»™æ‰€æœ‰ agents å¤ç”¨
```

**é¢„æœŸæ€§èƒ½æå‡**: ~15-25%

### 6. å¹¶è¡Œ Agent æ‰§è¡Œ (ä¸­ä¼˜å…ˆçº§)
**é—®é¢˜**: æ‰€æœ‰ agents ä¸²è¡Œæ‰§è¡Œï¼Œå³ä½¿å®ƒä»¬ä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»
**è§£å†³æ–¹æ¡ˆ**:
```python
# å¯¹äºŽæ²¡æœ‰ä¾èµ–å…³ç³»çš„ agentsï¼Œä½¿ç”¨å¹¶è¡Œæ‰§è¡Œ
from concurrent.futures import ThreadPoolExecutor

# è¯†åˆ«ç‹¬ç«‹çš„ agents
independent_agents = ["Info Agent", "Planning Agent"]  # ç¤ºä¾‹
# å¹¶è¡Œè°ƒç”¨
with ThreadPoolExecutor(max_workers=len(independent_agents)) as executor:
    futures = {executor.submit(agent.call, ...): name for name in independent_agents}
```

**æ³¨æ„**: éœ€è¦ä»”ç»†åˆ†æž agent ä¾èµ–å…³ç³»
**é¢„æœŸæ€§èƒ½æå‡**: ~30-60% (å–å†³äºŽå¯å¹¶è¡Œçš„ agents æ•°é‡)

### 7. Batch åˆ†ç»„ä¼˜åŒ– (ä¸­ä¼˜å…ˆçº§)
**é—®é¢˜**: å¯¹äºŽå·²æ‰¹å‡†å’Œæœªæ‰¹å‡†çš„æ ·æœ¬ï¼Œä»ä½¿ç”¨ç›¸åŒçš„å¤„ç†è·¯å¾„
**è§£å†³æ–¹æ¡ˆ**:
```python
# åˆ†ç¦»å·²æ‰¹å‡†å’Œæœªæ‰¹å‡†çš„æ ·æœ¬
approved_indices = np.where(approved_vector)[0]
unapproved_indices = np.where(~approved_vector)[0]

# ä»…å¯¹æœªæ‰¹å‡†çš„æ ·æœ¬è°ƒç”¨ agents
if len(unapproved_indices) > 0:
    # å¤„ç†æœªæ‰¹å‡†çš„æ ·æœ¬
    pass
```

**é¢„æœŸæ€§èƒ½æå‡**: ~10-20%

### 8. Team Context ä½¿ç”¨ List æ›¿ä»£å­—ç¬¦ä¸²æ‹¼æŽ¥ (ä½Žä¼˜å…ˆçº§)
**é—®é¢˜**: å­—ç¬¦ä¸²ä¸æ–­å¢žé•¿ï¼Œå¯¼è‡´å†…å­˜å’Œè®¡ç®—å¼€é”€
**è§£å†³æ–¹æ¡ˆ**:
```python
# ä½¿ç”¨ list å­˜å‚¨ context ç‰‡æ®µ
team_context = [[...] for _ in range(batch_size)]  # List of lists

# ä»…åœ¨éœ€è¦æ—¶æ‰ join
def get_context_string(i):
    return '\n'.join(team_context[i])
```

**é¢„æœŸæ€§èƒ½æå‡**: ~5-10% (å¯¹äºŽé•¿ context åœºæ™¯)

### 9. ä½¿ç”¨é…ç½®æŽ§åˆ¶ä¼˜åŒ–è¡Œä¸º
**å»ºè®®åœ¨ config ä¸­æ·»åŠ **:
```yaml
agent:
  performance:
    enable_early_termination: true  # æ—©æœŸç»ˆæ­¢
    enable_agent_skip: true  # è·³è¿‡æ— æ´»è·ƒæ ·æœ¬çš„ agent
    enable_preprocessing_cache: false  # é¢„å¤„ç†ç¼“å­˜ (éœ€è¦å®žçŽ°)
    enable_parallel_agents: false  # å¹¶è¡Œ agents (éœ€è¦å®žçŽ°)
    max_context_length: 8192  # é™åˆ¶ context é•¿åº¦
```

### 10. Profiling å’Œç›‘æŽ§
**å»ºè®®æ·»åŠ æ€§èƒ½ç›‘æŽ§**:
```python
import time

class SearchMultiAgentOrchestra(BaseOrchestra):
    def __init__(self, ...):
        super().__init__(...)
        self.agent_time_stats = {}  # è®°å½•æ¯ä¸ª agent çš„æ‰§è¡Œæ—¶é—´
    
    def run(self, ...):
        start_time = time.time()
        # ... æ‰§è¡Œé€»è¾‘ ...
        total_time = time.time() - start_time
        
        # å®šæœŸæ‰“å°ç»Ÿè®¡ä¿¡æ¯
        if step % 100 == 0:
            print(f"Multiagent rollout stats: {self.agent_time_stats}")
```

---

## æ€§èƒ½åŸºå‡†æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯
1. **å°æ‰¹é‡** (batch_size=8): æµ‹è¯•åŸºç¡€å¼€é”€
2. **ä¸­æ‰¹é‡** (batch_size=64): å¸¸è§è®­ç»ƒåœºæ™¯
3. **å¤§æ‰¹é‡** (batch_size=256): é«˜åžååœºæ™¯
4. **é«˜ approval çŽ‡** (>80%): æµ‹è¯• early termination æ•ˆæžœ
5. **ä½Ž approval çŽ‡** (<30%): æµ‹è¯•æœ€åæƒ…å†µ

### å…³é”®æŒ‡æ ‡
- **Rollout åžåé‡**: samples/second
- **æ¯ä¸ª agent çš„å¹³å‡æ—¶é—´**: è¯†åˆ«ç“¶é¢ˆ
- **GPU åˆ©ç”¨çŽ‡**: ç¡®ä¿ GPU ä¸ç©ºé—²
- **å†…å­˜ä½¿ç”¨**: é¿å… OOM

---

## æ€»ç»“

### å·²å®žçŽ°ä¼˜åŒ–çš„é¢„æœŸæ€»æ€§èƒ½æå‡
- **åŸºç¡€ä¼˜åŒ–**: 15-30%
- **Early termination**: 20-40% (å–å†³äºŽåœºæ™¯)
- **æ€»è®¡**: **35-70%** çš„æ€§èƒ½æå‡

### æŽ¨èçš„ä¸‹ä¸€æ­¥è¡ŒåŠ¨
1. âœ… **ç«‹å³å¯ç”¨**: å·²å®žçŽ°çš„ä¼˜åŒ–æ— éœ€é¢å¤–é…ç½®å³å¯ç”Ÿæ•ˆ
2. ðŸ”„ **çŸ­æœŸ** (1-2 å‘¨): å®žçŽ°é¢„å¤„ç†ç¼“å­˜ (#5)
3. ðŸ“Š **ä¸­æœŸ** (2-4 å‘¨): æ·»åŠ æ€§èƒ½ç›‘æŽ§å’Œ profiling (#10)
4. ðŸš€ **é•¿æœŸ** (1-2 æœˆ): å®žçŽ°å¹¶è¡Œ agent æ‰§è¡Œ (#6)

### æ³¨æ„äº‹é¡¹
- æ‰€æœ‰ä¼˜åŒ–éƒ½ä¿æŒäº†åŽŸæœ‰çš„åŠŸèƒ½å’Œè¯­ä¹‰
- ä¼˜åŒ–ä¸»è¦é’ˆå¯¹æ‰¹å¤„ç†å’Œæ¡ä»¶æ£€æŸ¥ï¼Œä¸å½±å“æ¨¡åž‹æŽ¨ç†
- å»ºè®®åœ¨ç”Ÿäº§çŽ¯å¢ƒä¸­è¿›è¡Œ A/B æµ‹è¯•éªŒè¯æ€§èƒ½æå‡

---

## é—®é¢˜æŽ’æŸ¥

å¦‚æžœæ€§èƒ½æ²¡æœ‰æå‡ï¼Œæ£€æŸ¥ï¼š
1. **Batch size å¤ªå°**: ä¼˜åŒ–å¯¹å° batch æ•ˆæžœä¸æ˜Žæ˜¾
2. **ç“¶é¢ˆåœ¨ LLM æŽ¨ç†**: å¯èƒ½éœ€è¦ä¼˜åŒ–æ¨¡åž‹æœ¬èº«
3. **I/O ç“¶é¢ˆ**: æ£€æŸ¥æ•°æ®åŠ è½½å’ŒçŽ¯å¢ƒäº¤äº’
4. **ç½‘ç»œç“¶é¢ˆ**: æ£€æŸ¥åˆ†å¸ƒå¼é€šä¿¡å¼€é”€
